
<dom-module id="display-grid-row">
    <template>
        <style>
            :host {
                display: block;
                overflow-x: visible;
                position: relative;
            }

            :host:first-child .grid-cell {
                margin-bottom: 0;
            }

            .grid-cell {

                box-sizing: border-box;

                display: inline-block;
                text-align: right;
                padding: 0; 
                margin: 0;
                flex-grow: 1;
                min-width: 3em;
                border: 3px solid rgba( 0,0,0,0 );
                margin-right: 1px;
                margin-bottom: 1px;

            }

            .grid-cell.selected {
                border-color: yellow;
                background: lightyellow;
            }

            .grid-cell.selected.selected-clear-top {
                border-top-color: rgba( 0,0,0,0 );
            }

            .grid-cell.selected.selected-clear-bottom {
                border-bottom-color: rgba( 0,0,0,0 );
            }

            .grid-cell.selected.selected-clear-left {
                border-left-color: rgba( 0,0,0,0 );
            }

            .grid-cell.selected.selected-clear-right {
                border-right-color: rgba( 0,0,0,0 );
            }

            .grid-cell:first-child {
                flex-grow: 0;
                position: relative;
                display: block;
                margin-right: 1px;

            }

            .grid-header {
                background: #def;
            }

            .grid-column-header, .grid-cell.grid-column-header:first-child  {

            }

            /*
            .grid-row-header {
                position: absolute;
                left: 0px;
            }
            */

            #row {
                white-space: nowrap;
                min-height: 1em;
                display: flex;
                overflow: visible;
            }

        </style>

        <div id='row'>
        </div>

    </template>
    <script>
        Polymer({
            
            is: "display-grid-row",

            maxwidth: 90,

            render: function( source, index, left, is_header ){

                if( source.data && source.data.length ){
                    for( let i = 0; i< source.data.length; i++ ){
                        if( this.cols.length <= i ){

                            let div = document.createElement( "pre" );
                            div.className = "grid-cell watch-data";
                            if( is_header ){
                                div.classList.add( "grid-column-header" );
                                div.classList.add( "grid-header" );
                            }
                            else if( i ) {
                                div.classList.add( "table-cell" );
                            }
                            div['data-col'] = i;
                            this.cols.push( div );
                            Polymer.dom(this.$.row).appendChild(div);

                            if( !this.header ){
                                this.header = this.cols[0];
                                this.header.classList.add( "grid-header" );
                                this.header.classList.add( "grid-row-header" );
                            }
                        }
                        this.cols[i].textContent = source.data[i][index];
                        this.cols[i].style["min-width"] = (source.widths[i]*3/4) + "em";
                        this.cols[i]['data-row'] = index;

                        if( i >= source.selection.start.c 
                            && i <= source.selection.end.c 
                            && index >= source.selection.start.r 
                            && index <= source.selection.end.r ){

                            this.cols[i].classList.add("selected");

                            if( i > source.selection.start.c )
                                this.cols[i].classList.add('selected-clear-left'); 
                            else this.cols[i].classList.remove('selected-clear-left'); 

                            if( i < source.selection.end.c )
                                this.cols[i].classList.add('selected-clear-right'); 
                            else this.cols[i].classList.remove('selected-clear-right'); 

                            if( index > source.selection.start.r )
                                this.cols[i].classList.add('selected-clear-top'); 
                            else this.cols[i].classList.remove('selected-clear-top'); 

                            if( index < source.selection.end.r )
                                this.cols[i].classList.add('selected-clear-bottom'); 
                            else this.cols[i].classList.remove('selected-clear-bottom'); 

                        }
                        else this.cols[i].classList.remove('selected');

                    }

                    this.header.style.left = left + "px";
              
                    for( let i = source.data.length + 1; i< this.cols.length; i++ ){
                        this.cols[i].style= "display: none;";
                    }

                }

            },

            created: function(){
                this.cols = [];
            }

        })
    </script>
</dom-module>

<dom-module id="display-grid">
    <template>

        <style>

            :host {
                flex-grow: 1;
                display: flex;
            }

            .grid-list {
                overflow: auto;
                flex-grow: 1;
                position: relative;
                display: flex;
                flex-direction: column;
            }

            #grid-rows {
                position: relative;
                flex-grow: 1;
                margin: 0;
                padding: 0;
                border: 0;
            }

            #list {
                position: absolute;
                top: 0px;
                left: 0px;
                bottom: 0px;
                right: 0px;
            }

            #column-headers {
                display: none;
                margin: 0;
                padding: 0;
                border: 0;
            }

            #column-headers.visible {
                display: flex;
            }

        </style>

        <div class='grid-list'>
            <div id='grid-rows'>
                <virtual-list-grid class='check' id='list' template='display-grid-row'></virtual-list>
            </div>
        </div>

    </template>
    <script>

        Polymer({
            is: "display-grid",

            resetWidths: function(){
                this.$.list.source.widths = null;
            },

            listeners: {
                'mousedown': 'mousedown',
                'mouseup': 'mouseup',
                'keydown': 'keydown'
            },

            keydown: function(e){
                e.stopPropagation();
                e.preventDefault();

                //console.info(e);

                if( e.keyCode === 27 ){ // escape
                    this.clear_selection();
                    this.async_refresh();
                    return;
                }
                if( e.keyCode === 65 && e.ctrlKey ){
                    this.select_all( true );
                    this.async_refresh();
                    return;
                }
                else if( e.keyCode === 67 && e.ctrlKey ){
                    
                    // this is one place where column-dominant is expensive
                    let src = this.$.list.source;
                    if( src.selection.start < 1 || src.selection.end < 1 ) return;

                    console.info( src.data );

                    let data = [];
                    for( let r = src.selection.start.r; r<= src.selection.end.r; r++ ){
                        let line = [];
                        for( let c = src.selection.start.c; c<= src.selection.end.c; c++ ){
                            line.push( src.data[c][r].toString());
                        }
                        data.push( line.join( "\t" ));
                    }
                    
                    const {clipboard} = require('electron');
                    clipboard.writeText(data.join("\n"));

                    //console.info( data.join( "\n" ));

                }

            },

            clear_selection: function(){
                this.$.list.source.selection = {
                    start: { r: -1, c: -1 },
                    end: { r: -1, c: -1 }
                }
            },

            select_range: function( r1, c1, r2, c2 ){
                this.$.list.source.selection = {
                    start: { r: r1, c: c1 },
                    end: { r: r2, c: c2 }
                }
            },

            select_all: function( state ){
                if( !state ) this.clear_selection();
                else {
                    let src = this.$.list.source;
                    let c = src.data.length - 1; 
                    let r = src.length - 1;
                    this.select_range( 1, 1, r, c );
                }
            },

            select: function( row, col ){
                this.select_range( row, col, row, col );
            },

            async_refresh: function(){
                let instance = this
                requestAnimationFrame( function(){
                    instance.refresh();
                });
            },

            mousedown: function(e){

                e.stopPropagation();
                e.preventDefault();

                this.focus();

                if( !e.target.className.match( /table-cell/ )){
                    // console.info( e.target.className );
                    return;
                }

                let row = e.target['data-row'];
                let col = e.target['data-col'];               

                // clear selection, add current, refresh.
                // track cell, so we can limit changes 
                // and more efficiently process deltas
          
                this.$.list.source.selected = [];
                this.select( row, col );
                this.current_selection = [ row, col ];
                this.selection_start = [ row, col ];
                this.async_refresh();

                this.listen( this, 'mousemove', 'move' );

            },

            mouseup: function(e){
                e.stopPropagation();
                e.preventDefault();
                
                let row = e.target['data-row'];
                let col = e.target['data-col'];               
                this.unlisten( this, 'mousemove', 'move' );
            },

            move: function(e){
                e.stopPropagation();
                e.preventDefault();

                let row = e.target['data-row'];
                let col = e.target['data-col'];               

                if( row === this.current_selection[0] && col === this.current_selection[1] ) return;

                // (maybe) more efficient: flush and recreate
                this.$.list.source.selected = [];
                this.select_range( 
                    Math.min( row, this.selection_start[0] ), 
                    Math.min( col, this.selection_start[1] ), 
                    Math.max( row, this.selection_start[0] ), 
                    Math.max( col, this.selection_start[1] ), true );

                this.current_selection = [ row, col ];
                this.async_refresh();

            },

            click: function(e) {
                // alert("Thank you for tapping");
                e.stopPropagation();
                let row = e.target['data-row'];
                let col = e.target['data-col'];               

                if( !this.$.list.source.selected[row] ) this.$.list.source.selected[row] = [];
                if( !this.$.list.source.selected[row][col] ) this.$.list.source.selected[row][col] = true;
                else this.$.list.source.selected[row][col] = false;

                console.info( row, col );

                let instance = this;
                setImmediate( function(){
                    instance.refresh();
                });

            },

            updateData: function(data, headers, preserve_columns){

                if( !this.$.list.source ) this.$.list.source = {};
                let source = this.$.list.source; // ref

                source.selected = null

                if( data ){
                    source.length = data[0].length;
                    source.data = data;
                    source.headers = headers;
                    this.clear_selection();

                    if( !preserve_columns ){
                        source.widths = [];
                        for( let i = 0; i< data.length; i++ ){
                            let s, tmp = 2;
                            for( let r = 0; r< source.length; r++ ){
                                s = data[i][r] || "";
                                tmp = Math.max( tmp, s.toString().length);
                            }
                            source.widths[i] = tmp;
                        }
                    }

               }
                else {
                    source.length = 0;
                    source.data = null;
                    source.widths = null;
                    this.$['grid-origin'].style.width = "0px";
                }

                this.refresh();

            },

            attached: function(){
                if( !this.$.list.source ) this.$.list.source = { length: 0 };
                this.tabIndex = 0;
            },

            refresh: function(){
                this.$.list.dataChanged();
            }            

        })

    </script>
</dom-module>

